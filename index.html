<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Status | PeakD</title>
    <meta property="og:title" content="Status | PeakD" />
    <meta property="twitter:title" content="PeakD Status Page" />
    <meta name="description" content="Status of peakd.com and related services" />
    <meta name="twitter:description" content="Status of peakd.com and related services" />
    <meta property="og:image" content="https://beta.peakd.com/assets/images/peakd_logo_compact_256.png" />
    <meta property="twitter:image" content="https://beta.peakd.com/assets/images/peakd_logo_compact_256.png" />
    <meta name="twitter:card" content="summary" />
    <meta property=og:site_name content=PeakD>
    <meta property=twitter:site content=@PeakDcom>

    <link href="https://fonts.googleapis.com/css?family=Montserrat:500" rel="stylesheet" type="text/css">
    <link href="styles.css" rel="stylesheet" type="text/css">

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://peakd.com/assets/favicons/apple-touch-icon.png?v=zXbxAzp8l3">
    <link rel="icon" type="image/png" sizes="32x32" href="https://peakd.com/assets/favicons/favicon-32x32.png?v=zXbxAzp8l3">
    <link rel="icon" type="image/png" sizes="16x16" href="https://peakd.com/assets/favicons/favicon-16x16.png?v=zXbxAzp8l3">
    <link rel="mask-icon" href="https://peakd.com/assets/favicons/safari-pinned-tab.svg?v=zXbxAzp8l3" color="#4b4e4f">
    <link rel="shortcut icon" href="https://peakd.com/assets/favicons/favicon.ico?v=zXbxAzp8l3">
    <meta name="theme-color" content="#263238">

    <script type="text/javascript" src="https://unpkg.com/vue@2.6.10/dist/vue.js"></script>
    <script type="text/javascript" src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/steem/dist/steem.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/steemconnect@3.0.4"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sscjs@latest/dist/ssc.min.js"></script>

    <style>

    </style>
  </head>
  <body>
    <div id="main">
      <div class="message spacer">
        <img width="400" src="https://beta.peakd.com/assets/images/peakd_logo_white.svg" alt="PeakD">
        <div style="margin-top: 15px;">
          <h3>Current status of PeakD and the Hive Blockchain</h3>
        </div>
      </div>

      <section class="section--snippets spacer">
        <div class="flex--horizontal">
          <div class="snippets__cards flex--vertical">
            <div class="snippets__card flex--horizontal">
              <p>PeakD Website
                <small>PeakD main website status and availability</small>
              </p>
              <service-status :status="steempeakWebsite" :details="steempeakWebsiteDetails"></service-status>
            </div>

            <div class="snippets__card flex--horizontal">
              <p>PeakD API
                <small>PeakD API and database status</small>
              </p>
              <service-status :status="steempeakApi" :details="steempeakApiDetails"></service-status>
            </div>

            <div class="snippets__card flex--horizontal">
              <p>PeakD Backend
                <small>The node that handle post scheduling, witness monitor and post promotion services</small>
              </p>
              <service-status :status="steempeakNode" :details="steempeakNodeDetails"></service-status>
            </div>

            <div class="snippets__card flex--horizontal">
              <p>PeakD Hivemind
                <small>PeakD Hivemind nodes power some exclusive features as account lists and favorites</small>
              </p>
              <service-status :status="steempeakHivemind" :details="steempeakHivemindDetails"></service-status>
            </div>

            <div class="snippets__card flex--horizontal">
              <p>Cloudflare
                <small>CDN (Content Delivery Network) used to speed up PeakD page load</small>
              </p>
              <service-status :status="steempeakCdn"></service-status>
            </div>

            <div class="snippets__card flex--horizontal">
              <p>Hive API/RPC Nodes
                <small>
                  Hive API and RPC nodes used to retrieve data and cast transactions.
                  <br>
                  For additional details and stats check <a href="https://hivestatus.usehive.com/" target="_blank" rel="noopener" class="font-success">this page</a>
                </small>
              </p>
              <div>
                <h3 v-if="!steemNodes">...</h3>
                <h5 v-else>
                  <span v-for="node in steemNodes" :class="node.success ? 'font-success' : 'font-danger'" style="display: block; margin-top: 2px; margin-bottom: 2px;">{{ node.label }}</span>
                  <span v-if="steemconnect === null" style="display: block; margin-top: 2px; margin-bottom: 2px;">...</span>
                  <span v-else :class="steemconnect ? 'font-success' : 'font-danger'" style="display: block; margin-top: 2px; margin-bottom: 2px;">hivesigner</span>
                </h5>
              </div>
            </div>

            <!--
            <div class="snippets__card flex--horizontal">
              <p>Steem Engine
                <small>Steem Engine is the building block for Tribes and SE Tokens</small>
              </p>
              <service-status :status="steemEngine" :details="steemEngineDetails"></service-status>
            </div>

            <div class="snippets__card flex--horizontal">
              <p>Scotbot
                <small>Scotbot powers all the Tribes and the SteemEngine tokens rewards</small>
              </p>
              <service-status :status="scotbot" :details="scotbotDetails"></service-status>
            </div>
            -->
          </div>
        </div>
      </section>

      <div class="mountains-bg">
        <div class="mountain">
          <div class="mountain-top">
            <div class="mountain-cap-1"></div>
            <div class="mountain-cap-2"></div>
            <div class="mountain-cap-3"></div>
          </div>
        </div>
        <div class="mountain-two">
          <div class="mountain-top">
            <div class="mountain-cap-1"></div>
            <div class="mountain-cap-2"></div>
            <div class="mountain-cap-3"></div>
          </div>
        </div>
        <div class="mountain-three">
          <div class="mountain-top">
            <div class="mountain-cap-1"></div>
            <div class="mountain-cap-2"></div>
            <div class="mountain-cap-3"></div>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      const steempeakEndpoint = window.location.hostname.startsWith('localhost') ? 'http://localhost:9000' : 'https://peakd.com';
      const steempeakHiveEndpoint ='https://hive.peakd.com/health/';
      const cloudflareEndpoint = 'https://yh6f0r4529hb.statuspage.io/api/v2/status.json';
      const steemUrls = [
        { name: 'api.hive.blog', url: 'https://api.hive.blog', label: 'api.hive.blog' },
        { name: 'anyx.io', url: 'https://anyx.io', label: 'anyx.io' },
        { name: 'api.openhive.network', url: 'https://api.openhive.network', label: 'api.openhive.network' }
      ];
      const steemconnectClient = new steemconnect.Client({
        app: 'steempeak-status.app',
        apiURL: 'https://hivesigner.com',
        baseURL: 'https://hivesigner.com'
      });
      const scotbotEndpoint = 'https://scot-api.steem-engine.com/state';
      const ssc = new SSC('https://api.steem-engine.com/rpc');

      window.onload = function() {
        Vue.config.devtools = true

        Vue.component('service-status', {
          props: ['status', 'details'],
          template: `
            <div>
              <h3 v-if="status === null">...</h3>
              <h3 v-else-if="status" class="font-success">UP<small v-if="details">({{ details }})</small></h3>
              <h3 v-else class="font-danger">DOWN</h3>
            </div>
          `
        })

        new Vue({
          el: '#main',
          data: {
            steempeakWebsite: null,
            steempeakWebsiteDetails: null,
            steempeakApi: null,
            steempeakApiDetails: null,
            steempeakNode: null,
            steempeakNodeDetails: null,
            steempeakHivemind: null,
            steempeakHivemindDetails: null,
            steempeakCdn: null,
            steemNodes: null,
            steemconnect: null,
            steemEngine: null,
            steemEngineDetails: null,
            scotbot: null,
            scotbotDetails: null
          },
          mounted: function () {
            console.log('Status page mounted')

            this.refresh()
          },
          methods: {
            reset () {
              steempeakWebsite = null;
              steempeakWebsiteDetails = null;
              steempeakApi = null;
              steempeakApiDetails = null;
              steempeakNode = null;
              steempeakNodeDetails = null;
              steempeakHivemind = null;
              steempeakHivemindDetails = null;
              steempeakCdn = null;
              steemconnect = null;
              steemNodes = null;
              steemEngine = null;
              steemEngineDetails = null;
              scotbot = null;
              scotbotDetails = null;
            },
            async refresh () {
              this.reset();

              axios.get(`${steempeakEndpoint}/actuator/info`).then(response => {
                console.log(response);
                this.steempeakWebsite = response && response.data && response.data.app;
                this.steempeakWebsiteDetails = `Ver ${(response && response.data && response.data.app && response.data.app.version) || '?'}`;
              }).catch(error => {
                console.error(error);
                this.steempeakWebsite = false;
              });

              let startTime = new Date()
              axios.get(`${steempeakEndpoint}/api/public/status/monitor`).then(response => {
                console.log(response);
                this.steempeakApi = true;
                this.steempeakApiDetails = `${(new Date()).getTime() - startTime.getTime()} ms`
              }).catch(error => {
                console.error(error);
                this.steempeakApi = false;
              });

              axios.get(`${steempeakEndpoint}/api/public/status/monitor`).then(response => {
                console.log(response);
                this.steempeakNode = true;
                this.steempeakNodeDetails = `Blk ${response.data.value || '?'}`
              }).catch(error => {
                console.error(error);
                this.steempeakNode = false;
              });

              axios.get(steempeakHiveEndpoint).then(response => {
                console.log(response);
                this.steempeakHivemind = true;
                this.steempeakHivemindDetails = `Blk ${response.data.state.db_head_block || '?'}`
              }).catch(error => {
                console.error(error);
                this.steempeakHivemind = false;
              });

              axios.get(cloudflareEndpoint).then(response => {
                console.log(response);

                this.steempeakCdn = response && response.data && response.data.status && (response.data.status.indicator === 'none' || response.data.status.indicator === 'minor');
              }).catch(error => {
                console.error(error);
                this.steempeakCdn = false;
              });

              axios.post('https://api.steemconnect.com/api/me', {}, {
                headers: {
                  authorization: 'eyJzaWduZWRfbWVzc2FnZSI6eyJ0eXBlIjoicG9zdGluZyIsImFwcCI6Ii0ifSwiYXV0aG9ycyI6WyItIl0sInRpbWVzdGFtcCI6MTU3OTg4MjUwOCwic2lnbmF0dXJlcyI6WyIxZjYzNTYwZDA2NjRkMmNlOGM1MmZlYTJkN2FkYjkyMTQ1NmIyZTcwM2I1N2MyZGJhNjFkZTBjYjM5MGVjMGM5MDg2MzdiMTkyZTZjZjExNjkwZTAxYmI3ZmVjMjg2MzBmNWFjYTJkZWY2OTA2MzE5MTc1NDViYjA2NWFmYTA4Y2I2Il19'
                },
                timeout: 5000
              }).then(result => {
                console.log('Steemconnect result: ', result)
                this.steemconnect = true
              }).catch(error => {
                console.error('Steemconnect error: ', error)
                if (error.message && error.message.startsWith('timeout of ') && error.message.endsWith('exceeded')) {
                  this.steemconnect = false
                } else {
                  this.steemconnect = true
                }
              })

              axios.get(scotbotEndpoint).then(response => {
                console.log(response);

                this.scotbot = true
                this.scotbotDetails = `Delay ${parseInt(response.data.time_delay_seconds / 60)}m`
              }).catch(error => {
                console.error(error);
                this.scotbot = false;
              });

              ssc.getLatestBlockInfo((error, result) => {
                console.log(error, result);

                if (error) {
                  console.log(error);
                  this.steemEngine = false;
                } else {
                  console.error(result);
                  this.steemEngine = true;
                  this.steemEngineDetails = `Blk ${result.refSteemBlockNumber || '?'}`;
                }
              });

              let steemResults = {};
              for (let node of steemUrls) {
                console.log('Checking node: ' + node.url);

                let results = []
                try {
                  steem.api.setOptions({ url: node.url });
                  results.push(await steem.api.getDynamicGlobalPropertiesAsync());
                  results.push(await steem.api.getAccountsAsync(['peakd']));
                  results.push(await await steem.api.getWitnessesByVoteAsync('', 20));
                  steemResults[node.name] = {
                    success: true,
                    label: node.label,
                    results: results
                  };
                } catch (error) {
                  steemResults[node.name] = {
                    success: false,
                    label: node.label
                  };
                }
              }
              this.steemNodes = steemResults;
            }
          }
        });
      };
    </script>
  </body>
</html>
